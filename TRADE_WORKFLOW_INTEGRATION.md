# äº¤æ˜“å·¥ä½œæµ NestJS é›†æˆæ–‡æ¡£

## æ¦‚è¿°

æˆåŠŸå°† `tradeWorkflow` é›†æˆåˆ° NestJS çš„ Mastra æ¨¡å—ä¸­ï¼Œæä¾›äº†å®Œæ•´çš„ REST API æ¥å£ç”¨äºäº¤æ˜“ç­–ç•¥ç”Ÿæˆå’Œè¯„ä¼°ã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½
- **äº¤æ˜“åˆ†æ**: åˆ†æç”¨æˆ·äº¤æ˜“éœ€æ±‚å¹¶ä¼˜åŒ–ç­–ç•¥æç¤ºè¯
- **ç­–ç•¥ç”Ÿæˆ**: åŸºäºä¼˜åŒ–æç¤ºè¯ç”Ÿæˆé«˜è´¨é‡äº¤æ˜“æ–¹æ¡ˆ
- **äº¤æ˜“è¯„ä¼°**: è¯„ä¼°ç­–ç•¥è´¨é‡å¹¶æä¾›æ”¹è¿›å»ºè®®
- **å¾ªç¯ä¼˜åŒ–**: è‡ªåŠ¨é‡è¯•ç›´åˆ°è´¨é‡è¾¾æ ‡æˆ–è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°

### ğŸ¤– ä¸‰ä»£ç†åä½œç³»ç»Ÿ
1. **äº¤æ˜“åˆ†æä»£ç†** (`tradeAnalyzerAgent`) - åˆ†æäº¤æ˜“éœ€æ±‚ï¼Œä¼˜åŒ–ç­–ç•¥æç¤ºè¯
2. **ç­–ç•¥ç”Ÿæˆä»£ç†** (`tradeStrategyAgent`) - ç”Ÿæˆå…·ä½“çš„äº¤æ˜“ç­–ç•¥æ–¹æ¡ˆ
3. **äº¤æ˜“è¯„ä¼°ä»£ç†** (`tradeEvaluatorAgent`) - è¯„ä¼°ç­–ç•¥è´¨é‡ï¼Œæä¾›åé¦ˆ

## API æ¥å£

### 1. æ‰§è¡Œäº¤æ˜“å·¥ä½œæµ

**ç«¯ç‚¹**: `POST /mastra/workflows/trade`

**è¯·æ±‚æ ¼å¼**:
```json
{
  "userInput": "æˆ‘æƒ³åšè‚¡ç¥¨çŸ­çº¿äº¤æ˜“ï¼Œæœ‰ä»€ä¹ˆå¥½çš„ç­–ç•¥ï¼Ÿ",
  "maxRetries": 3
}
```

**è¯·æ±‚å‚æ•°**:
- `userInput` (string, å¿…éœ€): ç”¨æˆ·çš„äº¤æ˜“éœ€æ±‚æˆ–é—®é¢˜
- `maxRetries` (number, å¯é€‰): æœ€å¤§é‡è¯•æ¬¡æ•° (1-10ï¼Œé»˜è®¤ä¸ºé…ç½®å€¼)

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "data": {
    "success": true,
    "userInput": "æˆ‘æƒ³åšè‚¡ç¥¨çŸ­çº¿äº¤æ˜“ï¼Œæœ‰ä»€ä¹ˆå¥½çš„ç­–ç•¥ï¼Ÿ",
    "tradeAnalysis": {
      "originalInput": "æˆ‘æƒ³åšè‚¡ç¥¨çŸ­çº¿äº¤æ˜“ï¼Œæœ‰ä»€ä¹ˆå¥½çš„ç­–ç•¥ï¼Ÿ",
      "analyzedIntent": "ç”¨æˆ·å¸Œæœ›è·å¾—è‚¡ç¥¨çŸ­çº¿äº¤æ˜“çš„å…·ä½“ç­–ç•¥å»ºè®®",
      "optimizedPrompt": "è¯·æä¾›é€‚åˆè‚¡ç¥¨çŸ­çº¿äº¤æ˜“çš„å…·ä½“ç­–ç•¥...",
      "expectedOutputType": "äº¤æ˜“ç­–ç•¥æ–¹æ¡ˆ",
      "contextualHints": ["å…³æ³¨æŠ€æœ¯æŒ‡æ ‡", "æ§åˆ¶é£é™©", "è®¾ç½®æ­¢æŸ"],
      "qualityCriteria": ["ç­–ç•¥å¯è¡Œæ€§", "é£é™©æ§åˆ¶", "ç›ˆåˆ©æ½œåŠ›"]
    },
    "finalStrategy": {
      "generatedStrategy": "åŸºäºç§»åŠ¨å¹³å‡çº¿çš„çŸ­çº¿äº¤æ˜“ç­–ç•¥...",
      "strategyType": "æŠ€æœ¯åˆ†æç­–ç•¥",
      "keyPoints": ["ä½¿ç”¨5æ—¥å’Œ20æ—¥ç§»åŠ¨å¹³å‡çº¿", "è®¾ç½®2%æ­¢æŸ", "ç›®æ ‡æ”¶ç›Š3%"],
      "riskManagement": "ä¸¥æ ¼æ‰§è¡Œæ­¢æŸï¼Œå•æ¬¡äº¤æ˜“é£é™©ä¸è¶…è¿‡æ€»èµ„é‡‘çš„2%",
      "confidence": 0.85,
      "marketConditions": ["éœ‡è¡å¸‚åœº", "ä¸­ç­‰æ³¢åŠ¨ç‡"]
    },
    "tradeEvaluation": {
      "overallQuality": "PASS",
      "totalScore": 8.5,
      "dimensionScores": {
        "relevance": 9,
        "feasibility": 8,
        "riskControl": 8,
        "profitPotential": 8,
        "usefulness": 9
      },
      "feedback": "ç­–ç•¥æ•´ä½“å¯è¡Œï¼Œé£é™©æ§åˆ¶æªæ–½åˆç†...",
      "improvementSuggestions": ["å¯ä»¥è€ƒè™‘åŠ å…¥æˆäº¤é‡æŒ‡æ ‡"],
      "retryRecommended": false
    },
    "totalRetries": 1,
    "processingTime": "2500ms"
  },
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### 2. å¥åº·æ£€æŸ¥

**ç«¯ç‚¹**: `GET /mastra/health`

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "message": "Mastra service is running",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

## ä½¿ç”¨ç¤ºä¾‹

### cURL ç¤ºä¾‹

```bash
# å¥åº·æ£€æŸ¥
curl -X GET http://localhost:3000/mastra/health

# æ‰§è¡Œäº¤æ˜“å·¥ä½œæµ
curl -X POST http://localhost:3000/mastra/workflows/trade \
  -H "Content-Type: application/json" \
  -d '{
    "userInput": "æˆ‘æƒ³åšè‚¡ç¥¨çŸ­çº¿äº¤æ˜“ï¼Œæœ‰ä»€ä¹ˆå¥½çš„ç­–ç•¥ï¼Ÿ",
    "maxRetries": 2
  }'
```

### JavaScript ç¤ºä¾‹

```javascript
// ä½¿ç”¨ axios
const response = await axios.post('http://localhost:3000/mastra/workflows/trade', {
  userInput: 'æˆ‘æƒ³åšå¤–æ±‡äº¤æ˜“ï¼ŒEUR/USDè´§å¸å¯¹æœ‰ä»€ä¹ˆå¥½çš„ç­–ç•¥ï¼Ÿ',
  maxRetries: 3
});

console.log('äº¤æ˜“ç­–ç•¥:', response.data.data.finalStrategy);
```

### Python ç¤ºä¾‹

```python
import requests

response = requests.post('http://localhost:3000/mastra/workflows/trade', json={
    'userInput': 'æ¯”ç‰¹å¸ç°åœ¨é€‚åˆåšæ³¢æ®µäº¤æ˜“å—ï¼Ÿ',
    'maxRetries': 2
})

result = response.json()
if result['success']:
    strategy = result['data']['finalStrategy']
    print(f"ç­–ç•¥ç±»å‹: {strategy['strategyType']}")
    print(f"ä¿¡å¿ƒåº¦: {strategy['confidence']}")
```

## æ—¥å¿—è®°å½•

ç³»ç»Ÿæä¾›è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼ŒåŒ…æ‹¬ï¼š

### è¯·æ±‚çº§åˆ«æ—¥å¿—
- è¯·æ±‚å¼€å§‹æ—¶é—´å’Œå‚æ•°
- æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å…³é”®æ­¥éª¤
- å®Œæˆæ—¶é—´å’Œç»“æœæ‘˜è¦
- é”™è¯¯è¯¦æƒ…å’Œå †æ ˆè·Ÿè¸ª

### æ—¥å¿—ç¤ºä¾‹
```
[INFO] [abc123] Trade workflow request started
[INFO] [abc123] Executing trade workflow...
[INFO] [abc123] Trade workflow completed successfully
```

## é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯ç±»å‹

1. **è¾“å…¥éªŒè¯é”™è¯¯** (400)
   - ç©ºè¾“å…¥æˆ–æ— æ•ˆå‚æ•°
   - é‡è¯•æ¬¡æ•°è¶…å‡ºèŒƒå›´

2. **æœåŠ¡åˆå§‹åŒ–é”™è¯¯** (500)
   - Mastra æœåŠ¡æœªåˆå§‹åŒ–
   - å·¥ä½œæµæˆ–ä»£ç†æœªæ‰¾åˆ°

3. **æ‰§è¡Œé”™è¯¯** (500)
   - API å¯†é’¥æ— æ•ˆ
   - ç½‘ç»œè¿æ¥é—®é¢˜
   - ä»£ç†æ‰§è¡Œå¤±è´¥

### é”™è¯¯å“åº”æ ¼å¼
```json
{
  "success": false,
  "message": "Failed to run trade workflow",
  "error": "Trade analyzer agent not found",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

## æµ‹è¯•

### è¿è¡Œæµ‹è¯•è„šæœ¬

```bash
# å®‰è£…ä¾èµ–
npm install axios

# å¯åŠ¨ NestJS åº”ç”¨
npm run start:dev

# è¿è¡Œæµ‹è¯•è„šæœ¬
npx ts-node src/test-trade-workflow-api.ts
```

### æµ‹è¯•ç”¨ä¾‹

æµ‹è¯•è„šæœ¬åŒ…å«ä»¥ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼š
- è‚¡ç¥¨çŸ­çº¿äº¤æ˜“ç­–ç•¥
- å¤–æ±‡äº¤æ˜“ç­–ç•¥  
- åŠ å¯†è´§å¸äº¤æ˜“ç­–ç•¥
- æœŸè´§äº¤æ˜“ç­–ç•¥
- å¼‚å¸¸æƒ…å†µæµ‹è¯•ï¼ˆç©ºè¾“å…¥ã€è¶…é•¿è¾“å…¥ã€æ— æ•ˆå‚æ•°ï¼‰

## æ€§èƒ½è€ƒè™‘

### æ‰§è¡Œæ—¶é—´
- å…¸å‹æ‰§è¡Œæ—¶é—´ï¼š2-5ç§’
- å¤æ‚æŸ¥è¯¢å¯èƒ½éœ€è¦10-30ç§’
- è®¾ç½®äº†2åˆ†é’Ÿçš„è¶…æ—¶é™åˆ¶

### å¹¶å‘å¤„ç†
- æ”¯æŒå¤šä¸ªå¹¶å‘è¯·æ±‚
- æ¯ä¸ªè¯·æ±‚éƒ½æœ‰ç‹¬ç«‹çš„æ‰§è¡Œä¸Šä¸‹æ–‡
- å»ºè®®åœ¨æµ‹è¯•æ—¶æ·»åŠ è¯·æ±‚é—´éš”

## é…ç½®è¦æ±‚

### ç¯å¢ƒå˜é‡
```bash
GOOGLE_GENERATIVE_AI_API_KEY=your_api_key_here
```

### ä¾èµ–é¡¹
- NestJS æ¡†æ¶
- Mastra æ ¸å¿ƒåº“
- Google Generative AI API

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **API å¯†é’¥é”™è¯¯**
   - ç¡®ä¿è®¾ç½®äº†æ­£ç¡®çš„ `GOOGLE_GENERATIVE_AI_API_KEY`
   - æ£€æŸ¥ API å¯†é’¥æ˜¯å¦æœ‰æ•ˆä¸”æœ‰è¶³å¤Ÿé…é¢

2. **å·¥ä½œæµæœªæ‰¾åˆ°**
   - ç¡®è®¤ `tradeWorkflow` å·²æ­£ç¡®æ³¨å†Œåˆ° Mastra å®ä¾‹
   - æ£€æŸ¥å·¥ä½œæµ ID æ˜¯å¦åŒ¹é…

3. **ä»£ç†æœªæ‰¾åˆ°**
   - ç¡®è®¤ä¸‰ä¸ªäº¤æ˜“ä»£ç†éƒ½å·²æ­£ç¡®é…ç½®
   - æ£€æŸ¥ä»£ç†åç§°æ˜¯å¦åŒ¹é…

4. **è¶…æ—¶é”™è¯¯**
   - å¢åŠ å®¢æˆ·ç«¯è¶…æ—¶è®¾ç½®
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - è€ƒè™‘å‡å°‘ `maxRetries` å‚æ•°

## ä¸‹ä¸€æ­¥å»ºè®®

1. **æ·»åŠ è®¤è¯æˆæƒ** - ä¸º API æ¥å£æ·»åŠ å®‰å…¨è®¤è¯
2. **æ·»åŠ ç¼“å­˜æœºåˆ¶** - ç¼“å­˜ç›¸ä¼¼æŸ¥è¯¢çš„ç»“æœ
3. **æ€§èƒ½ç›‘æ§** - æ·»åŠ æ€§èƒ½æŒ‡æ ‡å’Œç›‘æ§
4. **æ‰¹é‡å¤„ç†** - æ”¯æŒæ‰¹é‡äº¤æ˜“ç­–ç•¥ç”Ÿæˆ
5. **WebSocket æ”¯æŒ** - å®æ—¶æ¨é€æ‰§è¡Œè¿›åº¦

## æ€»ç»“

äº¤æ˜“å·¥ä½œæµå·²æˆåŠŸé›†æˆåˆ° NestJS ä¸­ï¼Œæä¾›äº†ï¼š
- å®Œæ•´çš„ REST API æ¥å£
- è¯¦ç»†çš„æ—¥å¿—è®°å½•å’Œé”™è¯¯å¤„ç†
- ç±»å‹å®‰å…¨çš„ TypeScript æ”¯æŒ
- å…¨é¢çš„æµ‹è¯•ç”¨ä¾‹
- æ¸…æ™°çš„æ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹

ç³»ç»Ÿå·²å‡†å¤‡å¥½ç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œåªéœ€é…ç½® API å¯†é’¥å³å¯å¼€å§‹ä½¿ç”¨ã€‚
